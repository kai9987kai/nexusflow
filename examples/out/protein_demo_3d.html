<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>EcoAIDashboard Protein Viz</title>
<style>
:root{--bg:#07111f;--card:#101b31;--line:#23324d;--text:#e2e8f0;--muted:#9fb1c9;--accent:#22d3ee;--accent2:#86efac;}
*{box-sizing:border-box}body{margin:0;font-family:Segoe UI,system-ui,sans-serif;color:var(--text);background:radial-gradient(900px 320px at 0% 0%,rgba(34,211,238,.11),transparent 60%),linear-gradient(180deg,#030712,var(--bg))}
.wrap{max-width:1300px;margin:0 auto;padding:18px}.hero,.card{border:1px solid var(--line);background:rgba(16,27,49,.76);border-radius:14px;padding:12px}
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px;margin-top:12px}.subgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}button{background:#0f1b31;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 10px;cursor:pointer}button:hover{border-color:rgba(34,211,238,.35)}
label{font-size:12px;color:var(--muted)}input[type=range]{width:100%}
canvas{width:100%;height:420px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(2,6,23,.5)}.small canvas{height:260px}
pre{margin:0;background:rgba(2,6,23,.55);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px;max-height:420px;overflow:auto;font-size:12px}.muted{color:var(--muted)}.pill{display:inline-block;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:3px 8px;font-size:12px;margin-right:6px}
@media (max-width:980px){.grid{grid-template-columns:1fr}.subgrid{grid-template-columns:1fr}canvas{height:340px}.small canvas{height:240px}}
</style></head><body><div class="wrap">
<section class="hero"><h1 style="margin:0;font-size:22px">Protein Folding Visualization: albumin_fragment_3d</h1><div class="muted"><span class="pill">trajectory playback</span><span class="pill">Contact Map</span><span class="pill">Ramachandran-like</span></div></section>
<section class="grid"><div class="card"><canvas id="cv" width="760" height="420"></canvas><div class="toolbar"><button id="prev">Prev</button><button id="play">Play</button><button id="pause">Pause</button><button id="next">Next</button><label>Speed <input id="speed" type="range" min="1" max="20" value="6"></label></div><div style="margin-top:8px"><input id="slider" type="range" min="0" max="0" value="0"><div id="status" class="muted"></div></div></div><div class="card"><pre id="meta"></pre></div></section>
<section class="subgrid"><div class="card small"><h3 style="margin:0 0 8px 0;font-size:15px">Contact Map</h3><canvas id="contactMap" width="520" height="260"></canvas><div id="contactMeta" class="muted" style="margin-top:6px"></div></div><div class="card small"><h3 style="margin:0 0 8px 0;font-size:15px">Ramachandran-like Approximation</h3><canvas id="rama" width="520" height="260"></canvas><div id="ramaMeta" class="muted" style="margin-top:6px"></div></div></section>
<section class="card" style="margin-top:12px"><pre id="json"></pre></section>
</div>
<script>
const run = {"name": "albumin_fragment_3d", "kind": "protein_folding_3d", "sequence": "MKWVTFISLLFLFSSAYS", "length": 18, "steps": 130, "config": {"mode": "lattice3d", "temperature": 0.82, "sample_every": 6}, "acceptance_ratio": 0.55385, "final": {"energy": -9.2, "hydrophobic_contacts": 8, "salt_bridges": 0, "radius_gyration": 1.371, "compactness": 0.44444, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [2, -2, 0], [2, -1, 0], [2, 0, 0], [2, 0, 1], [2, -1, 1], [2, -1, 2], [2, -2, 2], [1, -2, 2], [1, -2, 1], [0, -2, 1], [0, -1, 1], [1, -1, 1], [1, -1, 2], [1, -1, 3]]}, "best": {"energy": -9.2, "hydrophobic_contacts": 8, "salt_bridges": 0, "radius_gyration": 1.371, "compactness": 0.44444, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [2, -2, 0], [2, -1, 0], [2, 0, 0], [2, 0, 1], [2, -1, 1], [2, -1, 2], [2, -2, 2], [1, -2, 2], [1, -2, 1], [0, -2, 1], [0, -1, 1], [1, -1, 1], [1, -1, 2], [1, -1, 3]]}, "trajectory": [{"step": 0, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 5.18813, "hydrophobic_contacts": 0}, {"step": 6, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.78961, "hydrophobic_contacts": 0}, {"step": 12, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.2551, "hydrophobic_contacts": 0}, {"step": 18, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.5209, "hydrophobic_contacts": 0}, {"step": 24, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.21503, "hydrophobic_contacts": 0}, {"step": 30, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.02714, "hydrophobic_contacts": 0}, {"step": 36, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.29843, "hydrophobic_contacts": 0}, {"step": 42, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 3.04544, "hydrophobic_contacts": 0}, {"step": 48, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.88408, "hydrophobic_contacts": 0}, {"step": 54, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.90328, "hydrophobic_contacts": 0}, {"step": 60, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.76385, "hydrophobic_contacts": 0}, {"step": 66, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.96533, "hydrophobic_contacts": 0}, {"step": 72, "energy": 0.0, "best_energy": 0.0, "radius_gyration": 2.83224, "hydrophobic_contacts": 0}, {"step": 78, "energy": -3.45, "best_energy": -3.45, "radius_gyration": 1.87659, "hydrophobic_contacts": 3}, {"step": 84, "energy": -2.3, "best_energy": -3.45, "radius_gyration": 2.00693, "hydrophobic_contacts": 2}, {"step": 90, "energy": -4.6, "best_energy": -4.6, "radius_gyration": 1.53659, "hydrophobic_contacts": 4}, {"step": 96, "energy": -4.6, "best_energy": -4.6, "radius_gyration": 1.8733, "hydrophobic_contacts": 4}, {"step": 102, "energy": -6.9, "best_energy": -6.9, "radius_gyration": 1.4153, "hydrophobic_contacts": 6}, {"step": 108, "energy": -6.9, "best_energy": -6.9, "radius_gyration": 1.40655, "hydrophobic_contacts": 6}, {"step": 114, "energy": -6.9, "best_energy": -6.9, "radius_gyration": 1.4153, "hydrophobic_contacts": 6}, {"step": 120, "energy": -6.9, "best_energy": -6.9, "radius_gyration": 1.35742, "hydrophobic_contacts": 6}, {"step": 126, "energy": -6.9, "best_energy": -6.9, "radius_gyration": 1.35742, "hydrophobic_contacts": 6}, {"step": 129, "energy": -9.2, "best_energy": -9.2, "radius_gyration": 1.371, "hydrophobic_contacts": 8}], "frames": [{"step": 0, "coords3d": [[0, 0, 0], [1, 0, 0], [2, 0, 0], [3, 0, 0], [4, 0, 0], [5, 0, 0], [6, 0, 0], [7, 0, 0], [8, 0, 0], [9, 0, 0], [10, 0, 0], [11, 0, 0], [12, 0, 0], [13, 0, 0], [14, 0, 0], [15, 0, 0], [16, 0, 0], [17, 0, 0]]}, {"step": 6, "coords3d": [[0, 0, 0], [1, 0, 0], [2, 0, 0], [3, 0, 0], [3, -1, 0], [3, -2, 0], [3, -3, 0], [3, -4, 0], [3, -5, 0], [3, -6, 0], [3, -6, -1], [3, -6, -2], [3, -6, -3], [3, -6, -4], [3, -6, -5], [3, -6, -6], [3, -6, -7], [3, -6, -8]]}, {"step": 12, "coords3d": [[0, 0, 0], [1, 0, 0], [2, 0, 0], [3, 0, 0], [3, 1, 0], [3, 2, 0], [3, 3, 0], [3, 4, 0], [3, 5, 0], [3, 6, 0], [3, 6, -1], [3, 6, -2], [2, 6, -2], [1, 6, -2], [0, 6, -2], [-1, 6, -2], [-2, 6, -2], [-2, 6, -3]]}, {"step": 18, "coords3d": [[0, 0, 0], [1, 0, 0], [2, 0, 0], [3, 0, 0], [3, 1, 0], [3, 2, 0], [2, 2, 0], [1, 2, 0], [0, 2, 0], [-1, 2, 0], [-1, 2, -1], [-1, 2, -2], [-1, 1, -2], [-1, 0, -2], [-1, -1, -2], [-1, -2, -2], [-1, -3, -2], [-2, -3, -2]]}, {"step": 24, "coords3d": [[0, 0, 0], [1, 0, 0], [2, 0, 0], [3, 0, 0], [3, 1, 0], [3, 2, 0], [2, 2, 0], [1, 2, 0], [0, 2, 0], [-1, 2, 0], [-1, 2, -1], [-1, 2, -2], [-2, 2, -2], [-3, 2, -2], [-4, 2, -2], [-5, 2, -2], [-6, 2, -2], [-6, 3, -2]]}, {"step": 30, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [1, -2, -1], [1, -2, -2], [1, -1, -2], [1, 0, -2], [1, 1, -2], [1, 2, -2], [0, 2, -2], [-1, 2, -2], [-1, 3, -2], [-1, 4, -2], [-1, 5, -2], [-1, 6, -2], [-2, 6, -2], [-2, 5, -2]]}, {"step": 36, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, 1], [0, -1, 1], [-1, -1, 1], [-1, 0, 1], [-1, 1, 1], [-1, 2, 1], [-1, 3, 1], [-1, 3, 2], [-1, 3, 3], [-1, 4, 3], [-1, 5, 3], [-1, 6, 3], [-1, 7, 3], [-1, 7, 4], [-2, 7, 4]]}, {"step": 42, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [2, -1, 0], [2, -1, 1], [2, -1, 2], [2, 0, 2], [2, 1, 2], [2, 2, 2], [2, 3, 2], [3, 3, 2], [4, 3, 2], [4, 3, 3], [4, 3, 4], [4, 3, 5], [4, 3, 6], [4, 4, 6], [5, 4, 6]]}, {"step": 48, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [1, -2, 1], [1, -2, 2], [1, -1, 2], [1, 0, 2], [1, 1, 2], [1, 2, 2], [2, 2, 2], [3, 2, 2], [3, 2, 3], [3, 2, 4], [3, 2, 5], [3, 2, 6], [4, 2, 6], [5, 2, 6]]}, {"step": 54, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [1, -2, 1], [1, -2, 2], [1, -2, 3], [1, -2, 4], [1, -1, 4], [1, 0, 4], [2, 0, 4], [3, 0, 4], [3, 0, 5], [4, 0, 5], [5, 0, 5], [5, 0, 6], [5, -1, 6], [5, -2, 6]]}, {"step": 60, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [1, -2, -1], [1, -3, -1], [1, -4, -1], [1, -5, -1], [2, -5, -1], [3, -5, -1], [3, -5, -2], [3, -5, -3], [3, -4, -3], [3, -4, -4], [3, -4, -5], [3, -5, -5], [2, -5, -5], [1, -5, -5]]}, {"step": 66, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [1, -2, -1], [1, -2, -2], [1, -2, -3], [1, -2, -4], [0, -2, -4], [0, -2, -5], [0, -3, -5], [0, -4, -5], [-1, -4, -5], [-1, -5, -5], [-1, -6, -5], [0, -6, -5], [1, -6, -5], [2, -6, -5]]}, {"step": 72, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [1, -2, -1], [2, -2, -1], [3, -2, -1], [4, -2, -1], [4, -1, -1], [5, -1, -1], [5, 0, -1], [5, 0, -2], [5, 1, -2], [5, 1, -3], [5, 1, -4], [5, 2, -4], [6, 2, -4], [7, 2, -4]]}, {"step": 78, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [1, -2, -1], [2, -2, -1], [3, -2, -1], [3, -2, 0], [2, -2, 0], [2, -2, 1], [1, -2, 1], [1, -1, 1], [0, -1, 1], [0, 0, 1], [0, 1, 1], [0, 1, 0], [-1, 1, 0], [-2, 1, 0]]}, {"step": 84, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [0, -1, -1], [0, -2, -1], [0, -3, -1], [0, -3, 0], [0, -2, 0], [0, -2, 1], [0, -1, 1], [-1, -1, 1], [-1, -2, 1], [-1, -2, 2], [-1, -2, 3], [-2, -2, 3], [-2, -3, 3], [-2, -4, 3]]}, {"step": 90, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [2, -1, -1], [2, -1, 0], [2, -1, 1], [2, -2, 1], [2, -2, 0], [2, -3, 0], [2, -3, -1], [1, -3, -1], [1, -3, 0], [1, -2, 0], [0, -2, 0], [0, -3, 0], [0, -3, 1], [0, -3, 2]]}, {"step": 96, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [2, -1, -1], [2, -1, 0], [2, -1, 1], [2, -2, 1], [2, -2, 0], [2, -3, 0], [2, -3, -1], [1, -3, -1], [1, -3, 0], [0, -3, 0], [0, -4, 0], [1, -4, 0], [1, -5, 0], [1, -6, 0]]}, {"step": 102, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [2, -1, -1], [2, -1, 0], [2, -1, 1], [2, -2, 1], [2, -2, 0], [2, -3, 0], [2, -3, -1], [1, -3, -1], [1, -2, -1], [0, -2, -1], [0, -2, 0], [1, -2, 0], [1, -2, 1], [1, -2, 2]]}, {"step": 108, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [2, -1, 0], [2, -1, 1], [1, -1, 1], [0, -1, 1], [0, -2, 1], [1, -2, 1], [1, -3, 1], [2, -3, 1], [2, -3, 0], [2, -2, 0], [2, -2, -1], [1, -2, -1], [1, -2, 0], [0, -2, 0], [-1, -2, 0]]}, {"step": 114, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -1, -1], [2, -1, -1], [2, -1, 0], [2, -1, 1], [2, -2, 1], [2, -2, 0], [2, -3, 0], [2, -3, -1], [1, -3, -1], [1, -2, -1], [0, -2, -1], [0, -2, 0], [1, -2, 0], [1, -2, 1], [1, -2, 2]]}, {"step": 120, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [2, -2, 0], [2, -1, 0], [2, 0, 0], [2, 0, 1], [2, -1, 1], [2, -1, 2], [2, -2, 2], [1, -2, 2], [1, -2, 1], [0, -2, 1], [0, -1, 1], [1, -1, 1], [1, 0, 1], [1, 1, 1]]}, {"step": 126, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [2, -2, 0], [2, -1, 0], [2, 0, 0], [2, 0, 1], [2, -1, 1], [2, -1, 2], [2, -2, 2], [1, -2, 2], [1, -2, 1], [0, -2, 1], [0, -1, 1], [1, -1, 1], [1, 0, 1], [1, 1, 1]]}, {"step": 129, "coords3d": [[0, 0, 0], [1, 0, 0], [1, -1, 0], [1, -2, 0], [2, -2, 0], [2, -1, 0], [2, 0, 0], [2, 0, 1], [2, -1, 1], [2, -1, 2], [2, -2, 2], [1, -2, 2], [1, -2, 1], [0, -2, 1], [0, -1, 1], [1, -1, 1], [1, -1, 2], [1, -1, 3]]}], "residue_types": {"hydrophobic": 12, "polar": 5, "positive": 1, "negative": 0}, "created_at": "2026-02-26T15:37:19.681574+00:00"};
const frames = Array.isArray(run.frames) ? run.frames : [];
const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
const slider = document.getElementById('slider');
const speed = document.getElementById('speed');
const contactCv = document.getElementById('contactMap'), contactCtx = contactCv.getContext('2d');
const ramaCv = document.getElementById('rama'), ramaCtx = ramaCv.getContext('2d');
let playTimer = null;
let playing = false;
slider.max = String(Math.max(0, frames.length - 1));
document.getElementById('meta').textContent = JSON.stringify({kind: run.kind, length: run.length, metrics_best: run.best, metrics_final: run.final, config: run.config, frames: frames.length, trajectory: Array.isArray(run.trajectory)?run.trajectory.length:0}, null, 2);
document.getElementById('json').textContent = JSON.stringify(run, null, 2);
function project(p) {
  if (!Array.isArray(p)) return [0, 0];
  if (p.length === 2) return [Number(p[0]||0), Number(p[1]||0)];
  const x=Number(p[0]||0), y=Number(p[1]||0), z=Number(p[2]||0);
  return [x + z * 0.55, y - z * 0.35];
}
function currentFrameIndex() {
  return Math.max(0, Math.min(frames.length - 1, Number(slider.value)||0));
}
function getFrame() {
  return frames.length ? (frames[currentFrameIndex()] || null) : null;
}
function getCoords() {
  const f = getFrame();
  if (f) return f.coords3d || f.coords2d || [];
  return (run.final && (run.final.coords3d || run.final.coords2d)) || [];
}
function latticeDistance(a, b) {
  let s = 0;
  const n = Math.max(Array.isArray(a)?a.length:0, Array.isArray(b)?b.length:0);
  for (let i=0;i<n;i++) s += Math.abs(Number((a||[])[i]||0) - Number((b||[])[i]||0));
  return s;
}
function bondPairs(coords) {
  const pts = coords.map(p => [Number(p[0]||0), Number(p[1]||0), Number(p[2]||0)]);
  const out = [];
  for (let i=1;i<pts.length-1;i++) {
    const p0=pts[i-1], p1=pts[i], p2=pts[i+1];
    const v1=[p1[0]-p0[0], p1[1]-p0[1], p1[2]-p0[2]];
    const v2=[p2[0]-p1[0], p2[1]-p1[1], p2[2]-p1[2]];
    const phi = Math.atan2(v1[1], v1[0]) * 180 / Math.PI;
    const psi = Math.atan2(v2[2], Math.hypot(v2[0], v2[1]) || 1) * 180 / Math.PI * 2;
    const dot = v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
    const den = (Math.hypot(v1[0], v1[1], v1[2]) || 1) * (Math.hypot(v2[0], v2[1], v2[2]) || 1);
    const bend = Math.acos(Math.max(-1, Math.min(1, dot / den))) * 180 / Math.PI;
    out.push([phi, psi, bend]);
  }
  return out;
}
function drawContactMap(coords) {
  const w=contactCv.width,h=contactCv.height;
  contactCtx.clearRect(0,0,w,h); contactCtx.fillStyle='#081021'; contactCtx.fillRect(0,0,w,h);
  const pad = 20; const n = Math.max(1, coords.length); const sz = Math.min(w - pad*2, h - pad*2); const cell = Math.max(2, Math.floor(sz / Math.max(8, n)));
  contactCtx.strokeStyle='rgba(148,163,184,.25)'; contactCtx.strokeRect(pad,pad,sz,sz);
  let contacts = 0;
  for (let i=0;i<coords.length;i++) {
    for (let j=0;j<coords.length;j++) {
      const x = pad + (i / n) * sz;
      const y = pad + (j / n) * sz;
      if (i === j) { contactCtx.fillStyle='rgba(148,163,184,.35)'; contactCtx.fillRect(x,y,cell,cell); continue; }
      const backbone = Math.abs(i-j) <= 1;
      const dist = latticeDistance(coords[i], coords[j]);
      if (!backbone && dist === 1) { if (i < j) contacts++; contactCtx.fillStyle='rgba(134,239,172,.82)'; contactCtx.fillRect(x,y,cell,cell); }
      else if (!backbone && dist === 2) { contactCtx.fillStyle='rgba(34,211,238,.18)'; contactCtx.fillRect(x,y,cell,cell); }
    }
  }
  document.getElementById('contactMeta').textContent = 'contacts=' + contacts + ' | lattice adjacency';
}
function drawRama(coords) {
  const w=ramaCv.width,h=ramaCv.height, pad=28, pw=w-pad*2, ph=h-pad*2;
  ramaCtx.clearRect(0,0,w,h); ramaCtx.fillStyle='#081021'; ramaCtx.fillRect(0,0,w,h);
  ramaCtx.strokeStyle='rgba(148,163,184,.2)';
  for (let i=0;i<=4;i++) { const x=pad+i*pw/4, y=pad+i*ph/4; ramaCtx.beginPath(); ramaCtx.moveTo(x,pad); ramaCtx.lineTo(x,pad+ph); ramaCtx.stroke(); ramaCtx.beginPath(); ramaCtx.moveTo(pad,y); ramaCtx.lineTo(pad+pw,y); ramaCtx.stroke(); }
  ramaCtx.strokeStyle='rgba(148,163,184,.42)'; ramaCtx.strokeRect(pad,pad,pw,ph);
  const pairs = bondPairs(coords);
  const sx = (v)=> pad + ((v + 180) / 360) * pw;
  const sy = (v)=> pad + (1 - ((v + 180) / 360)) * ph;
  pairs.forEach((p, idx) => {
    const alpha = Math.min(1, 0.3 + 0.6 * ((Number(p[2]||0)) / 180));
    ramaCtx.fillStyle = 'rgba(245,158,11,' + alpha + ')';
    ramaCtx.beginPath(); ramaCtx.arc(sx(Number(p[0]||0)), sy(Number(p[1]||0)), 3.2, 0, Math.PI*2); ramaCtx.fill();
    if (idx === 0 || idx === pairs.length-1) { ramaCtx.strokeStyle='white'; ramaCtx.stroke(); }
  });
  ramaCtx.fillStyle='rgba(148,163,184,.75)'; ramaCtx.font='12px Segoe UI, sans-serif'; ramaCtx.fillText('phi approx', pad, 14); ramaCtx.fillText('psi approx', w-62, h-8);
  const avgBend = pairs.length ? (pairs.reduce((a,b)=>a+Number(b[2]||0),0)/pairs.length) : 0;
  document.getElementById('ramaMeta').textContent = 'points=' + pairs.length + ' | avg bend=' + avgBend.toFixed(1) + 'Â° (Ramachandran-like lattice proxy)';
}
function draw() {
  const coords = getCoords();
  const w=cv.width,h=cv.height; ctx.clearRect(0,0,w,h); ctx.fillStyle='#081021'; ctx.fillRect(0,0,w,h);
  if (!coords.length) { drawContactMap([]); drawRama([]); return; }
  const pts = coords.map(project);
  const xs = pts.map(p=>p[0]), ys = pts.map(p=>p[1]);
  const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
  const left=40,right=20,top=20,bottom=20,pw=w-left-right,ph=h-top-bottom;
  const sx=(x)=> left + ((x-minX)/Math.max(1e-6,(maxX-minX)||1))*pw;
  const sy=(y)=> top + (1-((y-minY)/Math.max(1e-6,(maxY-minY)||1)))*ph;
  ctx.strokeStyle='rgba(148,163,184,.22)'; for(let i=0;i<6;i++){let gy=top+i*ph/5;ctx.beginPath();ctx.moveTo(left,gy);ctx.lineTo(left+pw,gy);ctx.stroke();}
  ctx.lineWidth=2;
  for (let i=1;i<pts.length;i++) {
    const ax=pts[i-1][0], ay=pts[i-1][1], bx=pts[i][0], by=pts[i][1];
    ctx.strokeStyle='rgba(34,211,238,.65)'; ctx.beginPath(); ctx.moveTo(sx(ax), sy(ay)); ctx.lineTo(sx(bx), sy(by)); ctx.stroke();
  }
  for (let i=0;i<pts.length;i++) {
    const x=pts[i][0], y=pts[i][1];
    const aa = (run.sequence && run.sequence[i]) ? run.sequence[i] : '';
    const color = 'AILMFWVYC'.includes(aa) ? '#86efac' : ('KRH'.includes(aa) ? '#60a5fa' : ('DE'.includes(aa) ? '#fb7185' : '#f59e0b'));
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(sx(x), sy(y), 4, 0, Math.PI*2); ctx.fill();
    if (i===0 || i===pts.length-1) { ctx.strokeStyle='white'; ctx.stroke(); }
  }
  const idx = currentFrameIndex();
  const frame = frames[idx] || null;
  let trajMsg = '';
  if (Array.isArray(run.trajectory) && frame) {
    const t = run.trajectory.find(it => it && it.step === frame.step) || null;
    if (t) trajMsg = ' | energy=' + t.energy + ' | rg=' + t.radius_gyration;
  }
  document.getElementById('status').textContent = frame ? ('frame ' + (idx+1) + '/' + frames.length + ' step=' + frame.step + trajMsg) : 'final structure';
  drawContactMap(coords);
  drawRama(coords);
}
function stopPlayback() {
  playing = false;
  if (playTimer) { clearInterval(playTimer); playTimer = null; }
}
function startPlayback() {
  stopPlayback();
  if (!frames.length) return;
  playing = true;
  const fps = Math.max(1, Number(speed.value)||6);
  playTimer = setInterval(() => {
    const max = Math.max(0, frames.length - 1);
    const next = currentFrameIndex() >= max ? 0 : currentFrameIndex() + 1;
    slider.value = String(next);
    draw();
  }, Math.round(1000 / fps));
}
document.getElementById('prev').onclick = () => { stopPlayback(); slider.value = String(Math.max(0, currentFrameIndex() - 1)); draw(); };
document.getElementById('next').onclick = () => { stopPlayback(); slider.value = String(Math.min(Math.max(0, frames.length - 1), currentFrameIndex() + 1)); draw(); };
document.getElementById('play').onclick = startPlayback;
document.getElementById('pause').onclick = stopPlayback;
speed.oninput = () => { if (playing) startPlayback(); };
slider.oninput = () => { if (playing) stopPlayback(); draw(); };
draw();
</script></body></html>